<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Notion Trips Map</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <!-- Arrow heads on polylines -->
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.7.0/dist/leaflet.polylineDecorator.min.js"></script>

    <style>
      html, body { height: 100%; margin: 0; }
      #map { height: 100vh; width: 100vw; }

      .overlay {
        position: absolute;
        top: 12px;
        left: 12px;
        z-index: 9999;
        width: 380px;
        max-width: calc(100vw - 24px);
        background: rgba(255,255,255,0.94);
        border-radius: 14px;
        padding: 12px;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
        box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      }

      .header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
      }
      .header h1 {
        font-size: 14px;
        margin: 0;
        font-weight: 900;
      }
      .sub { font-size: 12px; opacity: .7; }

      .kpis { display: flex; gap: 10px; margin-bottom: 10px; }
      .kpi {
        flex: 1;
        background: rgba(0,0,0,0.04);
        border-radius: 12px;
        padding: 8px;
      }
      .kpi .label { font-size: 12px; opacity: 0.7; }
      .kpi .value { font-size: 16px; font-weight: 900; margin-top: 2px; }

      .legendRow { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
      .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; opacity: 0.85; }
      .dot { width: 10px; height: 10px; border-radius: 999px; display: inline-block; }
      .dot.dep { background: #d33; }
      .dot.arr { background: #2a9d4b; }
      .line { width: 18px; height: 2px; background: #2b6cb0; border-radius: 2px; display: inline-block; }

      .lists {
        max-height: 56vh;
        overflow: auto;
        display: grid;
        gap: 12px;
        padding-right: 2px;
      }

      .sectionTitle {
        font-weight: 900;
        font-size: 12px;
        margin: 0 0 6px;
        opacity: .85;
      }

      .card {
        border-radius: 14px;
        padding: 9px 10px;
        background: rgba(0,0,0,0.04);
        cursor: pointer;
        border: 1px solid rgba(0,0,0,0.06);
      }
      .card:hover { background: rgba(0,0,0,0.07); }
      .card .title { font-weight: 900; font-size: 13px; }
      .card .meta { margin-top: 4px; font-size: 12px; opacity: .82; display:flex; gap:6px; flex-wrap:wrap; }
      .badge { padding:2px 8px; border-radius:999px; background: rgba(0,0,0,0.08); font-size: 11px; }

      .card.green { border-left: 4px solid #2a9d4b; }
      .card.blue { border-left: 4px solid #2b6cb0; }
      .card.gray { border-left: 4px solid rgba(0,0,0,0.25); }

      .muted { opacity: .75; }

      /* Animated polylines (SVG) */
      .flight-path {
        stroke-dasharray: 8 10;
        animation: dash 2.2s linear infinite;
      }
      @keyframes dash { to { stroke-dashoffset: -18; } }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <div class="overlay">
      <div class="header">
        <h1>Trips</h1>
        <div class="sub" id="lastUpdated">—</div>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="label">Items</div>
          <div class="value" id="kpiItems">—</div>
        </div>
        <div class="kpi">
          <div class="label">Distance (transports)</div>
          <div class="value" id="kpiDistance">—</div>
        </div>
      </div>

      <div class="legendRow">
        <div class="legend-item"><span class="dot dep"></span>Ville départ</div>
        <div class="legend-item"><span class="dot arr"></span>Ville arrivée / séjour</div>
        <div class="legend-item"><span class="line" style="background:#2b6cb0;"></span>Flight</div>
        <div class="legend-item"><span class="line" style="background:#2a9d4b;"></span>Train</div>
      </div>

      <div class="lists">
        <div>
          <div class="sectionTitle">Trajets</div>
          <div id="tripList" style="display:grid; gap:8px;"></div>
        </div>

        <div>
          <div class="sectionTitle">Séjours</div>
          <div id="stayList" style="display:grid; gap:8px;"></div>
        </div>
      </div>
    </div>

    <script>
      const map = L.map("map", { worldCopyJump: true }).setView([20, 0], 2);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
        maxZoom: 19
      }).addTo(map);

      const markerCluster = L.markerClusterGroup();
      const transportLayer = L.layerGroup();
      markerCluster.addTo(map);
      transportLayer.addTo(map);

      // Icons
      const depIcon = new L.Icon({
        iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
        shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      const arrIcon = new L.Icon({
        iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
        shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      function formatKm(km) {
        return Math.round(km).toLocaleString("fr-FR") + " km";
      }

      function formatDateFr(iso) {
        if (!iso) return "—";
        if (iso.length === 10) return iso.split("-").reverse().join("/");
        return new Date(iso).toLocaleDateString("fr-FR");
      }

      function dateLabel(depIso, arrIso) {
        const d1 = formatDateFr(depIso);
        const d2 = formatDateFr(arrIso);
        if (!arrIso) return `Date: ${d1}`;
        return `${d1} → ${d2}`;
      }

      function cityOnly(label, fallback) {
        if (!label) return fallback;
        return (label.split(",")[0] || fallback).trim();
      }

      function nightsBetween(arrIso, depIso) {
        if (!arrIso || !depIso) return null;
        const a = new Date(arrIso.slice(0,10));
        const d = new Date(depIso.slice(0,10));
        const diff = Math.round((d - a) / (1000*60*60*24));
        return isFinite(diff) ? diff : null;
      }

      function isoDay(r) {
        const s = (r.departure_date || r.arrival_date || "");
        return s ? s.slice(0, 10) : "0000-00-00";
      }

      function prettyDay(iso) {
        if (!iso || iso === "0000-00-00") return "Date inconnue";
        return iso.split("-").reverse().join("/");
      }

      function normType(t) {
        return String(t || "").toLowerCase();
      }

      function lineColorForType(t) {
        const x = normType(t);
        if (x.includes("flight") || x.includes("plane") || x.includes("avion")) return "#2b6cb0"; // blue
        if (x.includes("train")) return "#2a9d4b"; // green
        return "#2b6cb0";
      }

      function lineWeightForType(t) {
        const x = normType(t);
        if (x.includes("train")) return 4;
        return 3;
      }

      function midpoint(a, b) {
        return L.latLng((a.lat + b.lat) / 2, (a.lng + b.lng) / 2);
      }

      // Great-circle-ish curve interpolation
      function interpolateCurve(a, b, steps = 48) {
        const lat1 = a.lat * Math.PI / 180, lon1 = a.lng * Math.PI / 180;
        const lat2 = b.lat * Math.PI / 180, lon2 = b.lng * Math.PI / 180;

        function toXYZ(lat, lon) {
          return { x: Math.cos(lat) * Math.cos(lon), y: Math.cos(lat) * Math.sin(lon), z: Math.sin(lat) };
        }
        const A = toXYZ(lat1, lon1);
        const B = toXYZ(lat2, lon2);

        const dot = A.x*B.x + A.y*B.y + A.z*B.z;
        const omega = Math.acos(Math.min(1, Math.max(-1, dot)));
        if (!isFinite(omega) || omega < 1e-6) return [a, b];

        const sinOmega = Math.sin(omega);
        const points = [];

        for (let i = 0; i <= steps; i++) {
          const t = i / steps;
          const s1 = Math.sin((1 - t) * omega) / sinOmega;
          const s2 = Math.sin(t * omega) / sinOmega;

          const x = s1*A.x + s2*B.x;
          const y = s1*A.y + s2*B.y;
          const z = s1*A.z + s2*B.z;

          const lat = Math.atan2(z, Math.sqrt(x*x + y*y)) * 180 / Math.PI;
          const lon = Math.atan2(y, x) * 180 / Math.PI;
          points.push(L.latLng(lat, lon));
        }
        return points;
      }

      async function loadRecords() {
        const res = await fetch("./cities.json", { cache: "no-store" });
        if (!res.ok) throw new Error(`Impossible de charger cities.json (${res.status})`);
        const data = await res.json();
        return Array.isArray(data) ? data : [];
      }

      function sortByDate(records) {
        const key = (r) => (r.departure_date || r.arrival_date || "");
        return [...records].sort((a,b) => key(a).localeCompare(key(b)));
      }

      function cardClassForType(t) {
        const x = normType(t);
        if (x.includes("train")) return "green";
        if (x.includes("flight") || x.includes("plane") || x.includes("avion")) return "blue";
        return "gray";
      }

      function render(records) {
        markerCluster.clearLayers();
        transportLayer.clearLayers();
        document.getElementById("tripList").innerHTML = "";
        document.getElementById("stayList").innerHTML = "";

        const bounds = L.latLngBounds([]);
        let totalKm = 0;

        const sorted = sortByDate(records);

        // click targets from timeline
        const cardTargets = new Map(); // id -> { bounds, open() }

        let lastTripDay = null;
        let lastStayDay = null;

        sorted.forEach((r, idx) => {
          const kind = r.kind || (r.departure ? "transport" : "stay");
          const ttype = r.type || "Unknown";
          const day = isoDay(r);

          const arrLatLng = (Array.isArray(r.arrival) && r.arrival.length === 2)
            ? L.latLng(r.arrival[0], r.arrival[1])
            : null;

          if (arrLatLng) bounds.extend(arrLatLng);

          // -------- STAY --------
          if (kind === "stay" || !r.departure) {
            if (!arrLatLng) return;

            if (day !== lastStayDay) {
              lastStayDay = day;
              const sep = document.createElement("div");
              sep.className = "muted";
              sep.style.fontSize = "12px";
              sep.style.fontWeight = "900";
              sep.style.margin = "10px 0 2px";
              sep.textContent = prettyDay(day);
              document.getElementById("stayList").appendChild(sep);
            }

            const city = cityOnly(r.arrival_label, "City");
            const arrD = formatDateFr(r.arrival_date);
            const depD = formatDateFr(r.departure_date);
            const nights = nightsBetween(r.arrival_date, r.departure_date);
            const nightsTxt = (nights !== null) ? `${nights} nuit(s)` : null;

            const popup = `
              <div style="font-family: ui-sans-serif, system-ui;">
                <div style="font-weight:900;">${city}</div>
                <div style="margin-top:6px;opacity:.8;">${ttype}</div>
                <div style="margin-top:6px;"><b>Arrivée:</b> ${arrD}</div>
                <div style="margin-top:4px;"><b>Départ:</b> ${depD}</div>
                ${nightsTxt ? `<div style="margin-top:6px;opacity:.8;">Durée: ${nightsTxt}</div>` : ``}
              </div>
            `;

            // stay marker is visible and can keep its popup
            const marker = L.marker(arrLatLng, { icon: arrIcon }).bindPopup(popup);
            markerCluster.addLayer(marker);

            const id = `stay-${idx}`;
            cardTargets.set(id, {
              bounds: L.latLngBounds([arrLatLng]),
              open: () => marker.openPopup()
            });

            const card = document.createElement("div");
            card.className = `card ${cardClassForType(ttype)}`;
            card.innerHTML = `
              <div class="title">${city}</div>
              <div class="meta">
                <span class="badge">${ttype}</span>
                <span class="badge">${arrD} → ${depD}${nightsTxt ? ` • ${nightsTxt}` : ""}</span>
              </div>
            `;
            card.addEventListener("click", () => {
              const target = cardTargets.get(id);
              if (!target) return;
              map.fitBounds(target.bounds.pad(0.7));
              setTimeout(() => target.open(), 200);
            });
            document.getElementById("stayList").appendChild(card);
            return;
          }

          // -------- TRANSPORT --------
          if (!Array.isArray(r.departure) || r.departure.length !== 2 || !arrLatLng) return;

          if (day !== lastTripDay) {
            lastTripDay = day;
            const sep = document.createElement("div");
            sep.className = "muted";
            sep.style.fontSize = "12px";
            sep.style.fontWeight = "900";
            sep.style.margin = "10px 0 2px";
            sep.textContent = prettyDay(day);
            document.getElementById("tripList").appendChild(sep);
          }

          const depLatLng = L.latLng(r.departure[0], r.departure[1]);
          bounds.extend(depLatLng);

          const depCity = cityOnly(r.departure_label, "Departure");
          const arrCity = cityOnly(r.arrival_label, "Arrival");
          const title = `${depCity} → ${arrCity}`;

          if (typeof r.distance_km === "number") totalKm += r.distance_km;

          // LINE (colored by type)
          const curve = interpolateCurve(depLatLng, arrLatLng, 48);
          const color = lineColorForType(ttype);
          const weight = lineWeightForType(ttype);

          const line = L.polyline(curve, {
            color,
            weight,
            opacity: 0.9,
            className: "flight-path"
          }).addTo(transportLayer);

          // Arrow head (direction)
          L.polylineDecorator(line, {
            patterns: [
              {
                offset: "60%",
                repeat: 0,
                symbol: L.Symbol.arrowHead({
                  pixelSize: 12,
                  polygon: false,
                  pathOptions: { stroke: true, color, weight: 2, opacity: 0.95 }
                })
              }
            ]
          }).addTo(transportLayer);

          // City markers (NO transport popup on them)
          markerCluster.addLayer(L.marker(depLatLng, { icon: depIcon }));
          markerCluster.addLayer(L.marker(arrLatLng, { icon: arrIcon }));

          // Transport popup attached to the ARROW (midpoint marker invisible)
          const depD = formatDateFr(r.departure_date);
          const arrD = formatDateFr(r.arrival_date);
          const dLabel = (!r.arrival_date) ? depD : `${depD} → ${arrD}`;

          const distLine = (typeof r.distance_km === "number")
            ? `<div style="margin-top:6px;opacity:.8;">Distance: ${r.distance_km.toLocaleString("fr-FR")} km</div>`
            : "";

          const popup = `
            <div style="font-family: ui-sans-serif, system-ui;">
              <div style="font-weight:900;">${title}</div>
              <div style="margin-top:6px;opacity:.8;">${ttype}</div>
              <div style="margin-top:6px;"><b>Date:</b> ${dLabel}</div>
              ${distLine}
            </div>
          `;

          const mid = midpoint(depLatLng, arrLatLng);
          const transportMarker = L.marker(mid, { opacity: 0, interactive: true }).bindPopup(popup);
          markerCluster.addLayer(transportMarker);

          // Clicking the line opens the popup on the arrow
          line.on("click", () => transportMarker.openPopup());

          // Card target
          const id = `trip-${idx}`;
          cardTargets.set(id, {
            bounds: L.latLngBounds([depLatLng, arrLatLng]),
            open: () => transportMarker.openPopup()
          });

          // Timeline card (colored by type)
          const card = document.createElement("div");
          card.className = `card ${cardClassForType(ttype)}`;
          card.innerHTML = `
            <div class="title">${title}</div>
            <div class="meta">
              <span class="badge">${ttype}</span>
              <span class="badge">${dateLabel(r.departure_date, r.arrival_date)}</span>
              ${typeof r.distance_km === "number" ? `<span class="badge">${Math.round(r.distance_km).toLocaleString("fr-FR")} km</span>` : ``}
            </div>
          `;
          card.addEventListener("click", () => {
            const target = cardTargets.get(id);
            if (!target) return;
            map.fitBounds(target.bounds.pad(0.55));
            setTimeout(() => target.open(), 200);
          });
          document.getElementById("tripList").appendChild(card);
        });

        // KPIs
        document.getElementById("kpiItems").textContent = sorted.length.toLocaleString("fr-FR");
        document.getElementById("kpiDistance").textContent = totalKm > 0 ? formatKm(totalKm) : "—";
        document.getElementById("lastUpdated").textContent = "maj: " + new Date().toLocaleDateString("fr-FR");

        if (bounds.isValid()) map.fitBounds(bounds.pad(0.2));

        if (sorted.length === 0) {
          L.popup().setLatLng([20, 0]).setContent("Aucun item à afficher (cities.json est vide).").openOn(map);
          document.getElementById("kpiItems").textContent = "0";
          document.getElementById("kpiDistance").textContent = "0 km";
        }
      }

      (async () => {
        try {
          const records = await loadRecords();
          render(records);
        } catch (e) {
          console.error(e);
          L.popup().setLatLng([20, 0]).setContent(`Erreur: ${e.message}`).openOn(map);
        }
      })();
    </script>
  </body>
</html>
