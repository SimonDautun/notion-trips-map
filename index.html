<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Notion Trips Map</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <style>
      html, body { height: 100%; margin: 0; }
      #map { height: 100vh; width: 100vw; }

      /* Overlay: stats + legend */
      .overlay {
        position: absolute;
        top: 12px;
        left: 12px;
        z-index: 9999;
        background: rgba(255,255,255,0.92);
        border-radius: 12px;
        padding: 10px 12px;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
        box-shadow: 0 10px 30px rgba(0,0,0,0.12);
        max-width: 320px;
      }
      .overlay h1 {
        font-size: 14px;
        margin: 0 0 8px;
        font-weight: 700;
      }
      .kpis { display: flex; gap: 10px; margin-bottom: 8px; }
      .kpi {
        flex: 1;
        background: rgba(0,0,0,0.04);
        border-radius: 10px;
        padding: 8px;
      }
      .kpi .label { font-size: 12px; opacity: 0.7; }
      .kpi .value { font-size: 16px; font-weight: 800; margin-top: 2px; }

      .legend { display: flex; gap: 10px; flex-wrap: wrap; }
      .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; opacity: 0.85; }
      .dot { width: 10px; height: 10px; border-radius: 999px; display: inline-block; }
      .dot.dep { background: #d33; }
      .dot.arr { background: #2a9d4b; }
      .line { width: 18px; height: 2px; background: #2b6cb0; border-radius: 2px; display: inline-block; }

      /* Animated polylines (SVG) */
      .flight-path {
        stroke-dasharray: 8 10;
        animation: dash 2.2s linear infinite;
      }
      @keyframes dash {
        to { stroke-dashoffset: -18; }
      }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <div class="overlay">
      <h1>Trips</h1>
      <div class="kpis">
        <div class="kpi">
          <div class="label">Trajets</div>
          <div class="value" id="kpiTrips">—</div>
        </div>
        <div class="kpi">
          <div class="label">Distance totale</div>
          <div class="value" id="kpiDistance">—</div>
        </div>
      </div>
      <div class="legend">
        <div class="legend-item"><span class="dot dep"></span>Departure</div>
        <div class="legend-item"><span class="dot arr"></span>Arrival</div>
        <div class="legend-item"><span class="line"></span>Trajet</div>
      </div>
    </div>

    <script>
      const map = L.map("map", { worldCopyJump: true }).setView([20, 0], 2);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
        maxZoom: 19
      }).addTo(map);

      // Simple colored markers
      const depIcon = new L.Icon({
        iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
        shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      const arrIcon = new L.Icon({
        iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
        shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      function isValidLatLon(x) {
        return Array.isArray(x) && x.length === 2 &&
          typeof x[0] === "number" && typeof x[1] === "number" &&
          isFinite(x[0]) && isFinite(x[1]);
      }

      function formatKm(km) {
        // format FR avec séparateur de milliers
        return Math.round(km).toLocaleString("fr-FR") + " km";
      }

      function formatDateFr(iso) {
        if (!iso) return "—";
        if (iso.length === 10) return iso.split("-").reverse().join("/");
        return new Date(iso).toLocaleDateString("fr-FR");
      }


      // Great-circle-ish curve interpolation (lightweight)
      function interpolateCurve(a, b, steps = 40) {
        const lat1 = a.lat * Math.PI / 180, lon1 = a.lng * Math.PI / 180;
        const lat2 = b.lat * Math.PI / 180, lon2 = b.lng * Math.PI / 180;

        // Convert to cartesian
        function toXYZ(lat, lon) {
          return {
            x: Math.cos(lat) * Math.cos(lon),
            y: Math.cos(lat) * Math.sin(lon),
            z: Math.sin(lat)
          };
        }
        const A = toXYZ(lat1, lon1);
        const B = toXYZ(lat2, lon2);

        // Angle between vectors
        const dot = A.x*B.x + A.y*B.y + A.z*B.z;
        const omega = Math.acos(Math.min(1, Math.max(-1, dot)));

        // If points are identical or nearly so
        if (!isFinite(omega) || omega < 1e-6) {
          return [a, b];
        }

        const sinOmega = Math.sin(omega);
        const points = [];

        for (let i = 0; i <= steps; i++) {
          const t = i / steps;
          const s1 = Math.sin((1 - t) * omega) / sinOmega;
          const s2 = Math.sin(t * omega) / sinOmega;

          const x = s1*A.x + s2*B.x;
          const y = s1*A.y + s2*B.y;
          const z = s1*A.z + s2*B.z;

          // back to lat/lon
          const lat = Math.atan2(z, Math.sqrt(x*x + y*y)) * 180 / Math.PI;
          const lon = Math.atan2(y, x) * 180 / Math.PI;
          points.push(L.latLng(lat, lon));
        }

        return points;
      }

      async function loadTrips() {
        const res = await fetch("./cities.json", { cache: "no-store" });
        if (!res.ok) throw new Error(`Impossible de charger cities.json (${res.status})`);
        const trips = await res.json();
        return Array.isArray(trips) ? trips : [];
      }

      function addTripsToMap(trips) {
        const bounds = L.latLngBounds([]);
        let totalKm = 0;

        trips.forEach((t, i) => {
          const dep = t.departure;
          const arr = t.arrival;

          if (!isValidLatLon(dep) || !isValidLatLon(arr)) return;

          const depLatLng = L.latLng(dep[0], dep[1]);
          const arrLatLng = L.latLng(arr[0], arr[1]);

          // Labels (fallback)
          const depLabel = t.departure_label || "Departure";
          const arrLabel = t.arrival_label || "Arrival";
          const arrLabelCity = (arrLabel.split(",")[0] || arrLabel).trim();
          const depDate = formatDateFr(t.departure_date);
          const arrDate = formatDateFr(t.arrival_date);

          // Distance (fallback: compute rough if absent)
          const distKm = typeof t.distance_km === "number" ? t.distance_km : null;
          if (distKm !== null) totalKm += distKm;

          // Markers + popups
          L.marker(depLatLng, { icon: depIcon }).addTo(map).bindPopup(`
            <div style="font-family: ui-sans-serif, system-ui;">
              <div style="font-weight:800;">${arrLabelCity}</div>
              <div style="margin-top:6px;"><b>Departure:</b> ${depDate}</div>
              <div style="margin-top:4px;"><b>Arrival:</b> ${arrDate}</div>
              ${distKm !== null ? `<div style="margin-top:6px;opacity:.8;">Distance: ${distKm.toLocaleString("fr-FR")} km</div>` : ``}
            </div>
          `);

          L.marker(arrLatLng, { icon: arrIcon }).addTo(map).bindPopup(`
            <div style="font-family: ui-sans-serif, system-ui;">
              <div style="font-weight:800;">${arrLabelCity}</div>
              <div style="margin-top:6px;"><b>Departure:</b> ${depDate}</div>
              <div style="margin-top:4px;"><b>Arrival:</b> ${arrDate}</div>
              ${distKm !== null ? `<div style="margin-top:6px;opacity:.8;">Distance: ${distKm.toLocaleString("fr-FR")} km</div>` : ``}
            </div>
          `);

          // Curved line + animation
          const curve = interpolateCurve(depLatLng, arrLatLng, 48);
          const path = L.polyline(curve, { weight: 2, opacity: 0.85, className: "flight-path" }).addTo(map);

          bounds.extend(depLatLng);
          bounds.extend(arrLatLng);
        });

        // Update KPIs
        document.getElementById("kpiTrips").textContent = trips.length.toLocaleString("fr-FR");
        document.getElementById("kpiDistance").textContent = totalKm > 0 ? formatKm(totalKm) : "—";

        // Fit bounds
        if (bounds.isValid()) {
          map.fitBounds(bounds.pad(0.2));
        }
      }

      (async () => {
        try {
          const trips = await loadTrips();
          addTripsToMap(trips);

          if (trips.length === 0) {
            L.popup()
              .setLatLng([20, 0])
              .setContent("Aucun trajet à afficher (cities.json est vide).")
              .openOn(map);
            document.getElementById("kpiTrips").textContent = "0";
            document.getElementById("kpiDistance").textContent = "0 km";
          }
        } catch (e) {
          console.error(e);
          L.popup()
            .setLatLng([20, 0])
            .setContent(`Erreur: ${e.message}`)
            .openOn(map);
        }
      })();
    </script>
  </body>
</html>
